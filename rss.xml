<?xml version="1.0" encoding="UTF-8"?>
<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
      <title>Brian&#x27;s Logbook</title>
      <link>https://blog.brianc.me</link>
      <description>Notes, thoughts, projects and blog posts by Brian Chen</description>
      <generator>Zola</generator>
      <language>en</language>
      <atom:link href="https://blog.brianc.me/rss.xml" rel="self" type="application/rss+xml"/>
      <lastBuildDate>Fri, 09 May 2025 00:00:00 +0000</lastBuildDate>
      <item>
          <title>Variables, Constants, and Naughty Strings</title>
          <pubDate>Thu, 24 Apr 2025 00:00:00 +0000</pubDate>
          <author>Brian Chen</author>
          <link>https://blog.brianc.me/posts/variables-and-constants/</link>
          <guid>https://blog.brianc.me/posts/variables-and-constants/</guid>
          <description xml:base="https://blog.brianc.me/posts/variables-and-constants/">

&lt;div
  class=&quot;my-4 flex flex-col rounded-lg bg-[var(--admonition-bg)]&quot;
  style=&quot;--admonition-bg: rgba(0, 191, 165, 0.1);&quot;
&gt;
  &lt;div class=&quot;flex items-center rounded-t-lg bg-[var(--admonition-bg)] p-1&quot;&gt;
    &lt;div
      class=&quot;mx-2 h-4 w-4 text-[0] [background:var(--url)_center_center_no-repeat] dark:invert&quot;
      style=&quot;--url: url(.&#x2F;icons&#x2F;tip.svg);&quot;
    &gt;
      tip
    &lt;&#x2F;div&gt;
    &lt;span&gt;&lt;strong&gt;Copyright Notice&lt;&#x2F;strong&gt;&lt;&#x2F;span&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;pl-4&quot;&gt;&lt;p&gt;This post is licensed under &lt;a rel=&quot;nofollow noreferrer&quot; href=&quot;https:&#x2F;&#x2F;creativecommons.org&#x2F;licenses&#x2F;by-nc-nd&#x2F;4.0&#x2F;&quot;&gt;CC BY-NC-ND 4.0&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;This note encapsulates some details regarding variables and constants in Rust and C++. Specifically, &lt;code&gt;const&lt;&#x2F;code&gt;, &lt;code&gt;static&lt;&#x2F;code&gt;, &lt;code&gt;let&lt;&#x2F;code&gt; in Rust, and &lt;code&gt;const&lt;&#x2F;code&gt;, &lt;code&gt;auto&#x2F;int&#x2F;char&#x2F;...&lt;&#x2F;code&gt;, &lt;code&gt;constexpr&lt;&#x2F;code&gt; in C++.&lt;&#x2F;p&gt;
&lt;p&gt;Additionally there&#x27;s some extra notes related to &lt;a href=&quot;https:&#x2F;&#x2F;blog.brianc.me&#x2F;posts&#x2F;variables-and-constants&#x2F;#quirky-references&quot;&gt;references and strings in Rust&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;


&lt;div
  class=&quot;my-4 flex flex-col rounded-lg bg-[var(--admonition-bg)]&quot;
  style=&quot;--admonition-bg: rgba(68, 138, 255, 0.1);&quot;
&gt;
  &lt;div class=&quot;flex items-center rounded-t-lg bg-[var(--admonition-bg)] p-1&quot;&gt;
    &lt;div
      class=&quot;mx-2 h-4 w-4 text-[0] [background:var(--url)_center_center_no-repeat] dark:invert&quot;
      style=&quot;--url: url(.&#x2F;icons&#x2F;note.svg);&quot;
    &gt;
      note
    &lt;&#x2F;div&gt;
    &lt;span&gt;&lt;strong&gt;Nota Bene&lt;&#x2F;strong&gt;&lt;&#x2F;span&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;pl-4&quot;&gt;&lt;p&gt;In this note I&#x27;ll use Rust&#x27;s definition for things like &quot;constants&quot;, and map C++&#x27;s definitions onto Rust&#x27;s.&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;h2 id=&quot;rust&quot;&gt;Rust&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;let-local-variables-mutable-or-immutable&quot;&gt;&lt;code&gt;let&lt;&#x2F;code&gt;: Local Variables, Mutable or Immutable&lt;&#x2F;h3&gt;
&lt;p&gt;See &lt;a rel=&quot;nofollow noreferrer&quot; href=&quot;https:&#x2F;&#x2F;rust-book.cs.brown.edu&#x2F;ch03-01-variables-and-mutability.html&quot;&gt;TRPL 3.1. Variables and Mutability&lt;&#x2F;a&gt; for details.&lt;&#x2F;p&gt;
&lt;p&gt;In Rust, generally we have three types of &quot;values&quot;. Mutable variables, immutable variables, and constants. This is different from normal conversation, where the term &quot;variable&quot; implies mutability since, well, the thing &quot;varies&quot;.&lt;&#x2F;p&gt;
&lt;p&gt;A variable is defined using &lt;code&gt;let&lt;&#x2F;code&gt; with type inference which almost always works. The rare exception is when the compiler has no way of figuring out for sure which type a variable is. An example to this is when using &lt;code&gt;.collect()&lt;&#x2F;code&gt; &lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-1-1&quot;&gt;&lt;a href=&quot;#fn-1&quot;&gt;1&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#282c34;color:#dcdfe4;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; a &lt;&#x2F;span&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e5c07b;&quot;&gt;10&lt;&#x2F;span&gt;&lt;span&gt;; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#5c6370;&quot;&gt;&#x2F;&#x2F; a: u32
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;let mut&lt;&#x2F;span&gt;&lt;span&gt; b: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;&amp;amp;str = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#98c379;&quot;&gt;&amp;quot;hello, world&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;By default, these variables are immutable. That is, their value cannot be changed. However, we can &quot;shadow&quot; the variable by declaring another variable of the exact same name. This new variable can be of a different type, different mutability, and different scope.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#282c34;color:#dcdfe4;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;color:#5c6370;&quot;&gt;&#x2F;&#x2F; a = 20; &#x2F;&#x2F; Would fail compilation
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;let mut&lt;&#x2F;span&gt;&lt;span&gt; a &lt;&#x2F;span&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e5c07b;&quot;&gt;20&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;    println!(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#98c379;&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e5c07b;&quot;&gt;{}&lt;&#x2F;span&gt;&lt;span style=&quot;color:#98c379;&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;, a); &lt;&#x2F;span&gt;&lt;span style=&quot;color:#5c6370;&quot;&gt;&#x2F;&#x2F; 20
&lt;&#x2F;span&gt;&lt;span&gt;    a &lt;&#x2F;span&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;*= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e5c07b;&quot;&gt;10&lt;&#x2F;span&gt;&lt;span&gt;; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#5c6370;&quot;&gt;&#x2F;&#x2F; Shadowed a becomes 200
&lt;&#x2F;span&gt;&lt;span&gt;} &lt;&#x2F;span&gt;&lt;span style=&quot;color:#5c6370;&quot;&gt;&#x2F;&#x2F; Shadowed a was dropped here
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#5c6370;&quot;&gt;&#x2F;&#x2F; a = 20; &#x2F;&#x2F; Would still fail compilation
&lt;&#x2F;span&gt;&lt;span&gt;println!(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#98c379;&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e5c07b;&quot;&gt;{}&lt;&#x2F;span&gt;&lt;span style=&quot;color:#98c379;&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;, a); &lt;&#x2F;span&gt;&lt;span style=&quot;color:#5c6370;&quot;&gt;&#x2F;&#x2F; 10
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; a &lt;&#x2F;span&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e5c07b;&quot;&gt;30&lt;&#x2F;span&gt;&lt;span&gt;; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#5c6370;&quot;&gt;&#x2F;&#x2F; Original a no longer accessible
&lt;&#x2F;span&gt;&lt;span&gt;println!(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#98c379;&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e5c07b;&quot;&gt;{}&lt;&#x2F;span&gt;&lt;span style=&quot;color:#98c379;&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;, a); &lt;&#x2F;span&gt;&lt;span style=&quot;color:#5c6370;&quot;&gt;&#x2F;&#x2F; 30
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;It is worth noting that, despite the code examples above, variables defined using &lt;code&gt;let&lt;&#x2F;code&gt; cannot have a global scope - they must exist in functions. Attempting to use &lt;code&gt;let&lt;&#x2F;code&gt; to define a global variable will yield this error message:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#282c34;color:#dcdfe4;&quot;&gt;&lt;code&gt;&lt;span&gt;`let` cannot be used for global variables
&lt;&#x2F;span&gt;&lt;span&gt;help: consider using `static` or `const` instead of `let`
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;However, they can exist inside closures used with &quot;lazy static&quot;. More on that later.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;quirky-references&quot;&gt;Quirky References&lt;&#x2F;h3&gt;
&lt;p&gt;In Rust, you can take references to variables (or constants, anything really) and store them inside another variable. Sorta like pointers. I&#x27;ll skip over stuff related to mutable and immutable references (&lt;code&gt;&amp;amp;&lt;&#x2F;code&gt; and &lt;code&gt;&amp;amp;mut&lt;&#x2F;code&gt;) since that&#x27;s a whole new topic related to the borrow checker, but here&#x27;s a quick example:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#282c34;color:#dcdfe4;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;let mut&lt;&#x2F;span&gt;&lt;span&gt; c: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;&amp;amp;u32 = &amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;a;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Here, &lt;code&gt;c&lt;&#x2F;code&gt; is a mutable variable holding an immutable reference to &lt;code&gt;a&lt;&#x2F;code&gt;. This means &lt;code&gt;c&lt;&#x2F;code&gt; can be changed to point at another &lt;code&gt;u32&lt;&#x2F;code&gt;, but you cannot modify &lt;code&gt;a&lt;&#x2F;code&gt; through &lt;code&gt;c&lt;&#x2F;code&gt; &lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-2-1&quot;&gt;&lt;a href=&quot;#fn-2&quot;&gt;2&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;. &lt;code&gt;c&lt;&#x2F;code&gt; also cannot be changed to point at any variable or constant of any other type (including other integer types), but it can be changed to point at a &lt;code&gt;u32&lt;&#x2F;code&gt; constant.&lt;&#x2F;p&gt;
&lt;p&gt;The real quirky stuff comes in when you consider literal strings. In Rust, hardcoded strings are &lt;code&gt;&amp;amp;str&lt;&#x2F;code&gt;, different from &lt;code&gt;String&lt;&#x2F;code&gt;. It&#x27;s widely known that &lt;code&gt;&amp;amp;str&lt;&#x2F;code&gt; lives on the stack since it has a fixed size, while &lt;code&gt;String&lt;&#x2F;code&gt; lives on the heap since its size is unknown at compile time. However, the reason there&#x27;s a &lt;code&gt;&amp;amp;&lt;&#x2F;code&gt; here is because &lt;code&gt;b&lt;&#x2F;code&gt; in the first example isn&#x27;t a string in itself. It&#x27;s a pointer to the literal string on the stack!&lt;&#x2F;p&gt;
&lt;p&gt;Given that &lt;code&gt;b&lt;&#x2F;code&gt; is mutable in the examples above, we can actually do this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#282c34;color:#dcdfe4;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span&gt;b &lt;&#x2F;span&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#98c379;&quot;&gt;&amp;quot;hello! world&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#5c6370;&quot;&gt;&#x2F;&#x2F; Reassigning b to a reference to another literal string on the stack
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; s &lt;&#x2F;span&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;String::from(b);
&lt;&#x2F;span&gt;&lt;span&gt;b &lt;&#x2F;span&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;= &amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;s[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e5c07b;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;..&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e5c07b;&quot;&gt;2&lt;&#x2F;span&gt;&lt;span&gt;]; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#5c6370;&quot;&gt;&#x2F;&#x2F; Reassigning b to a string slice, a reference to a String object on the heap
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;const-constants&quot;&gt;&lt;code&gt;const&lt;&#x2F;code&gt;: Constants&lt;&#x2F;h3&gt;
&lt;p&gt;Constants are something completely different in Rust. They are declared using the &lt;code&gt;const&lt;&#x2F;code&gt; keyword, can &lt;strong&gt;never&lt;&#x2F;strong&gt; be mutable, and have some additional quirks. Their conventional naming is the &lt;code&gt;SCREAMING_CASE&lt;&#x2F;code&gt; and their types must be manually annotated at definition, to name a few.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#282c34;color:#dcdfe4;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;const&lt;&#x2F;span&gt;&lt;span&gt; C: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;u32 = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e5c07b;&quot;&gt;100&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Since constants are always immutable, they can be defined in either a local or a global scope, and will always have thread-safe reads. Worth noting that the compiler is permitted to copy them around, and not necessarily reading its content from a fixed memory location.&lt;&#x2F;p&gt;
&lt;p&gt;Constants must be known at compile time, and thus only constant expressions are allowed inside. The details for allowed expressions can be found in &lt;a rel=&quot;nofollow noreferrer&quot; href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;stable&#x2F;reference&#x2F;const_eval.html&quot;&gt;The Rust Reference&lt;&#x2F;a&gt;, but in general, basic operations like arthimetic, logical, derefencing, casting, loops, structs&#x2F;tuples&#x2F;arrays. Worth noting that things that would normally panic (&lt;em&gt;e.g.&lt;&#x2F;em&gt;, out-of-bound indexing) would now raise a compile error if they are inside a &lt;code&gt;const&lt;&#x2F;code&gt; expression.&lt;&#x2F;p&gt;
&lt;p&gt;It is also worth noting that the operations mentioned above (known as &quot;constant expressions&quot;) can also be evaluated during compilation when they&#x27;re in &lt;code&gt;let&lt;&#x2F;code&gt; statements. This doesn&#x27;t necessarily happen, but the compiler is permitted to do so.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;const&lt;&#x2F;code&gt; is typically used to define actual constants, such as configurations, number of experiments, &lt;em&gt;etc.&lt;&#x2F;em&gt;, within the code for easy access.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;static-global-variables-mutable-or-immutable&quot;&gt;&lt;code&gt;static&lt;&#x2F;code&gt;: Global Variables, Mutable or Immutable&lt;&#x2F;h3&gt;
&lt;p&gt;&lt;code&gt;static&lt;&#x2F;code&gt; is usually used to define global variables. Similar to &lt;code&gt;let&lt;&#x2F;code&gt;, they can be mutable, but similar to &lt;code&gt;const&lt;&#x2F;code&gt;, they must have annotated types and the convention is to use all caps.&lt;&#x2F;p&gt;
&lt;p&gt;Even though they are called &quot;global variables&quot;, they can also be defined within a local scope, such as a function.&lt;&#x2F;p&gt;
&lt;p&gt;The reason why it&#x27;s called &quot;static&quot;, is that &lt;code&gt;static&lt;&#x2F;code&gt; items always have only one copy. All references of the object will be pointing at the exact same item. This is not the case for &lt;code&gt;const&lt;&#x2F;code&gt;. In technical terms, &lt;code&gt;static&lt;&#x2F;code&gt; objects have the &lt;code&gt;&#x27;static&lt;&#x2F;code&gt; lifetime, and &lt;code&gt;drop&lt;&#x2F;code&gt; is not called on it at the end of the program.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;static&lt;&#x2F;code&gt; is typically used to define application configurations or other variables shared by the entire application. Read-only access to &lt;code&gt;static&lt;&#x2F;code&gt; is thread safe. It is possible to use crates such as &lt;code&gt;once_cell&lt;&#x2F;code&gt; to initialise &lt;code&gt;static&lt;&#x2F;code&gt; objects at runtime startup, so it&#x27;s often used for things like reading from &lt;code&gt;.env&lt;&#x2F;code&gt; or other configuration paths during runtime. The data will be accessible throughout the entire duration of a program.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;static&lt;&#x2F;code&gt; can be defined as mutable, but that is unsafe due to the potential of data races which will lead to undefined behaviour. It is a common pattern to use &lt;code&gt;static&lt;&#x2F;code&gt; for things like the global state of a web application, in which case you can wrap &lt;code&gt;Mutex&lt;&#x2F;code&gt; inside a &lt;code&gt;static&lt;&#x2F;code&gt; immutable variable like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#282c34;color:#dcdfe4;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;use &lt;&#x2F;span&gt;&lt;span&gt;std::sync::{LazyLock, Mutex};
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;static &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e5c07b;&quot;&gt;ARRAY&lt;&#x2F;span&gt;&lt;span&gt;: LazyLock&amp;lt;Mutex&amp;lt;Vec&amp;lt;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;u8&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&amp;gt;&amp;gt; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;LazyLock::new(|| Mutex::new(vec![]));
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#c678dd;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;color:#61afef;&quot;&gt;do_a_call&lt;&#x2F;span&gt;&lt;span&gt;() {
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#e5c07b;&quot;&gt;ARRAY&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61afef;&quot;&gt;lock&lt;&#x2F;span&gt;&lt;span&gt;().&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61afef;&quot;&gt;unwrap&lt;&#x2F;span&gt;&lt;span&gt;().&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61afef;&quot;&gt;push&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#e5c07b;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;);
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Example provided by &lt;a rel=&quot;nofollow noreferrer&quot; href=&quot;https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;27791532&#x2F;how-do-i-create-a-global-mutable-singleton&quot;&gt;random StackOverflow question&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;You can call &lt;code&gt;*OTHER_STATIC_VARIABLE&lt;&#x2F;code&gt; inside the closure of another static variable to enforce the order of initilisation.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;c&quot;&gt;C++&lt;&#x2F;h2&gt;
&lt;p&gt;In C++, &lt;code&gt;const&lt;&#x2F;code&gt; is a modifier just like &lt;code&gt;mut&lt;&#x2F;code&gt; (doing the opposite), and there are no keyword separating local and global variables. They have &lt;code&gt;constexpr&lt;&#x2F;code&gt; instead of &lt;code&gt;const&lt;&#x2F;code&gt; for actual constants, and that&#x27;s basically it.&lt;&#x2F;p&gt;
&lt;p&gt;A few additional quirks:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Type inference can be used with &lt;code&gt;constexpr&lt;&#x2F;code&gt; (&lt;code&gt;constexpr auto a = 1;&lt;&#x2F;code&gt;)&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;constexpr&lt;&#x2F;code&gt; are immutable just like the Rust constants, so there&#x27;s no need to write &lt;code&gt;const constexpr&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;Similar to Rust&#x27;s case, constant expressions can be evaluated at compile time even when they are not defined with &lt;code&gt;constexpr&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Simple mapping which is probably not entirely accurate:&lt;&#x2F;p&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Rust&lt;&#x2F;th&gt;&lt;th&gt;C++&lt;&#x2F;th&gt;&lt;th&gt;Description&lt;&#x2F;th&gt;&lt;th&gt;Thread Safe&lt;&#x2F;th&gt;&lt;th&gt;Evaluated at Compile Time&lt;&#x2F;th&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;thead&gt;&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;code&gt;let mut&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;&lt;code&gt;auto&lt;&#x2F;code&gt;, &lt;code&gt;int&lt;&#x2F;code&gt;...&lt;&#x2F;td&gt;&lt;td&gt;Mutable Local Variable&lt;&#x2F;td&gt;&lt;td&gt;Yes&lt;&#x2F;td&gt;&lt;td&gt;Possible&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;code&gt;static mut&lt;&#x2F;code&gt;&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-3-1&quot;&gt;&lt;a href=&quot;#fn-3&quot;&gt;3&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;&lt;&#x2F;td&gt;&lt;td&gt;&lt;code&gt;auto&lt;&#x2F;code&gt;, &lt;code&gt;int&lt;&#x2F;code&gt;...&lt;&#x2F;td&gt;&lt;td&gt;Mutable Global Variable&lt;&#x2F;td&gt;&lt;td&gt;No&lt;&#x2F;td&gt;&lt;td&gt;Possible&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;code&gt;let&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;&lt;code&gt;const auto&lt;&#x2F;code&gt;&lt;sup class=&quot;footnote-reference&quot; id=&quot;fr-4-1&quot;&gt;&lt;a href=&quot;#fn-4&quot;&gt;4&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;, &lt;code&gt;const int&lt;&#x2F;code&gt;...&lt;&#x2F;td&gt;&lt;td&gt;Immutable Local Variable&lt;&#x2F;td&gt;&lt;td&gt;Yes&lt;&#x2F;td&gt;&lt;td&gt;Possible&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;code&gt;static&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;&lt;code&gt;const auto&lt;&#x2F;code&gt;, &lt;code&gt;const int&lt;&#x2F;code&gt;...&lt;&#x2F;td&gt;&lt;td&gt;Immutable Global Variable&lt;&#x2F;td&gt;&lt;td&gt;Yes&lt;&#x2F;td&gt;&lt;td&gt;Possible&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;code&gt;const&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;&lt;code&gt;constexpr auto&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;Constant&lt;&#x2F;td&gt;&lt;td&gt;Yes&lt;&#x2F;td&gt;&lt;td&gt;Yes, Always&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;&#x2F;tbody&gt;&lt;&#x2F;table&gt;
&lt;p&gt;To achieve &quot;thread-save mutable global variable&quot;, in C++ a similar design pattern (as described earlier) involving mutexes is often used.&lt;&#x2F;p&gt;
&lt;p&gt;C++, however, will not warn you at all that data races might happen if you define mutable global variables in a multi-threaded context, so if you accidentally do that, it&#x27;ll probably be a couple hours of painful debugging.&lt;&#x2F;p&gt;
&lt;section class=&quot;footnotes&quot;&gt;
&lt;ol class=&quot;footnotes-list&quot;&gt;
&lt;li id=&quot;fn-1&quot;&gt;
&lt;p&gt;You can either specify &lt;code&gt;.collect::&amp;lt;Type&amp;gt;()&lt;&#x2F;code&gt;, in which case the type of the variable is inferred, or specify the type of the variable, in which case the target of the &lt;code&gt;collect&lt;&#x2F;code&gt; method is inferred. &lt;a href=&quot;#fr-1-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li id=&quot;fn-2&quot;&gt;
&lt;p&gt;A mutable reference to &lt;code&gt;a&lt;&#x2F;code&gt; would also be invalid in itself, since &lt;code&gt;a&lt;&#x2F;code&gt; is immutable. &lt;a href=&quot;#fr-2-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li id=&quot;fn-3&quot;&gt;
&lt;p&gt;Only mutations require an &lt;code&gt;unsafe&lt;&#x2F;code&gt; block. &lt;a href=&quot;#fr-3-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li id=&quot;fn-4&quot;&gt;
&lt;p&gt;You can also write this as &lt;code&gt;auto const&lt;&#x2F;code&gt; (less common) but not &lt;code&gt;constexpr auto&lt;&#x2F;code&gt; as &lt;code&gt;auto constexpr&lt;&#x2F;code&gt;. This is because &lt;code&gt;constexpr&lt;&#x2F;code&gt; is a declaration specifier while &lt;code&gt;const&lt;&#x2F;code&gt; is a type qualifier. Declaration specifiers modify type specifiers (&lt;code&gt;auto&lt;&#x2F;code&gt;), hence they must appear in order. Type qualifiers can be anywhere. &lt;a href=&quot;#fr-4-1&quot;&gt;↩&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;&#x2F;section&gt;
</description>
      </item>
      <item>
          <title>Enviame - Interim Writeup</title>
          <pubDate>Wed, 16 Apr 2025 00:00:00 +0000</pubDate>
          <author>Brian Chen</author>
          <link>https://blog.brianc.me/projects/enviame/</link>
          <guid>https://blog.brianc.me/projects/enviame/</guid>
          <description xml:base="https://blog.brianc.me/projects/enviame/">

&lt;div
  class=&quot;my-4 flex flex-col rounded-lg bg-[var(--admonition-bg)]&quot;
  style=&quot;--admonition-bg: rgba(0, 191, 165, 0.1);&quot;
&gt;
  &lt;div class=&quot;flex items-center rounded-t-lg bg-[var(--admonition-bg)] p-1&quot;&gt;
    &lt;div
      class=&quot;mx-2 h-4 w-4 text-[0] [background:var(--url)_center_center_no-repeat] dark:invert&quot;
      style=&quot;--url: url(.&#x2F;icons&#x2F;tip.svg);&quot;
    &gt;
      tip
    &lt;&#x2F;div&gt;
    &lt;span&gt;&lt;strong&gt;Copyright Notice&lt;&#x2F;strong&gt;&lt;&#x2F;span&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;pl-4&quot;&gt;&lt;p&gt;This post is licensed under &lt;a rel=&quot;nofollow noreferrer&quot; href=&quot;https:&#x2F;&#x2F;creativecommons.org&#x2F;licenses&#x2F;by-nc-nd&#x2F;4.0&#x2F;&quot;&gt;CC BY-NC-ND 4.0&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;


&lt;div
  class=&quot;my-4 flex flex-col rounded-lg bg-[var(--admonition-bg)]&quot;
  style=&quot;--admonition-bg: rgba(0, 176, 255, 0.1);&quot;
&gt;
  &lt;div class=&quot;flex items-center rounded-t-lg bg-[var(--admonition-bg)] p-1&quot;&gt;
    &lt;div
      class=&quot;mx-2 h-4 w-4 text-[0] [background:var(--url)_center_center_no-repeat] dark:invert&quot;
      style=&quot;--url: url(.&#x2F;icons&#x2F;abstract.svg);&quot;
    &gt;
      abstract
    &lt;&#x2F;div&gt;
    &lt;span&gt;&lt;strong&gt;TL;DR&lt;&#x2F;strong&gt;&lt;&#x2F;span&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;pl-4&quot;&gt;&lt;br&#x2F;&gt;
&lt;details&gt;
&lt;summary&gt;Expand&lt;&#x2F;summary&gt;
&lt;p&gt;&lt;strong&gt;What&lt;&#x2F;strong&gt;: A full-stack app with a Rust backend to prioritise message delivery with configurable urgency, SSR frontend, and email + calendar integration.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;Why&lt;&#x2F;strong&gt;: To solve a personal problem around message prioritisation and experiment with Rust backend architecture.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;Stack&lt;&#x2F;strong&gt;: Rust (axum, tokio, sqlx, askama), PostgreSQL, Vanilla JS + Bootstrap.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;Philosophy&lt;&#x2F;strong&gt;: Overengineered on purpose to gain experience in industry-standard solutions.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;Status&lt;&#x2F;strong&gt;: MVP built and deployed in under a day, followed by QoL and scalability improvements. v1.0.9 feature-complete.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;Future&lt;&#x2F;strong&gt;: React&#x2F;Svelte SPA, OAuth2, more testing&#x2F;logging.&lt;&#x2F;p&gt;
&lt;&#x2F;details&gt;
&lt;br&#x2F;&gt;&lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;&#x2F;h2&gt;
&lt;p&gt;This is an interim writeup for &lt;a rel=&quot;nofollow noreferrer&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;differental&#x2F;enviame&quot;&gt;Enviame&lt;&#x2F;a&gt;, drafted after &lt;a rel=&quot;nofollow noreferrer&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;differental&#x2F;enviame&#x2F;releases&#x2F;tag&#x2F;v1.0.9&quot;&gt;v1.0.9&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Enviame is a simple project designed to solve my real-life problem of &lt;a href=&quot;https:&#x2F;&#x2F;blog.brianc.me&#x2F;projects&#x2F;enviame&#x2F;#motivation&quot;&gt;message prioritisation&lt;&#x2F;a&gt;, while also serving as an opportunity to build a full backend in Rust from scratch (with the help of various runtimes and libraries).&lt;&#x2F;p&gt;
&lt;h3 id=&quot;motivation&quot;&gt;Motivation&lt;&#x2F;h3&gt;
&lt;p&gt;At the core of all productivity techniques is a simple principle: minimise distractions to maintain focus. That’s why phones have Do Not Disturb modes and silence buttons.&lt;&#x2F;p&gt;
&lt;p&gt;The problem is, these tools often create an all-or-nothing scenario - either everything gets through, or nothing does. While some platforms offer limited solutions - like Apple’s iMessage showing when someone has silenced notifications and letting you bypass it if needed - most of us still rely on inconsistent systems like &quot;call if it’s urgent&quot;, which is often unreliable. For example, you would be fine with a friend calling about his lost ID during a focus study session, but not during an online interview or a sports race. After all, some fires burn hotter than others.&lt;&#x2F;p&gt;
&lt;p&gt;Enviame is designed to introduce more nuanced control, enabling different levels of message priority to ensure only the right messages get through at the right time.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;development-journey&quot;&gt;Development Journey&lt;&#x2F;h3&gt;
&lt;p&gt;All core features, with the exception of sending notification emails, were completed within the first 3 hours of development. The email features were then implemented within around 3 hours, making a working MVP within a day. Multiple hours were then spent setting up deployment pipelines (as this was new to me) and debugging the email features (which turns out was just &lt;a href=&quot;https:&#x2F;&#x2F;blog.brianc.me&#x2F;projects&#x2F;enviame&#x2F;#smtp-email-delivery&quot;&gt;inconsistent&lt;&#x2F;a&gt;), but by &lt;a rel=&quot;nofollow noreferrer&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;differental&#x2F;enviame&#x2F;releases&#x2F;tag&#x2F;v1.0.3&quot;&gt;v1.0.3&lt;&#x2F;a&gt; the project was already quite complete.&lt;&#x2F;p&gt;
&lt;p&gt;Most of the time afterwards was spent on QoL improvements, for example improving the frontend, minimising dependency usage, &lt;em&gt;etc.&lt;&#x2F;em&gt; The two largest features between v1.0.3 and v1.0.9 were the message delivery status display and the calendar status display, which were certainly not the largest features.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;design-philosophy&quot;&gt;Design Philosophy&lt;&#x2F;h3&gt;
&lt;p&gt;You may notice that the project is heavily overengineered, for example using &lt;code&gt;askama&lt;&#x2F;code&gt; for templating, using HTML minifiers, using cryptographically secure hashing for message queries, and having email and calendar worker threads, when obviously I won&#x27;t have 1000 friends sending me messages at once and obviously they aren&#x27;t malicious hackers trying to know whether someone else&#x27;s message got delivered. All of these were very much intentional.&lt;&#x2F;p&gt;
&lt;p&gt;The goal here is to gain experience in industry-standard solutions to these types of problems, instead of landing with &lt;em&gt;ad hoc&lt;&#x2F;em&gt; strategies that would only work for a few dozen users.&lt;&#x2F;p&gt;
&lt;p&gt;Making the deployment process smoother was also one of the goals that became increasingly important after an accident wiped the entire production server (oops). After v1.0.8, the building process was moved to the CI&#x2F;CD workflow so there is minimal setup and configuration required on the server side.&lt;&#x2F;p&gt;
&lt;hr &#x2F;&gt;
&lt;h2 id=&quot;technical-overview&quot;&gt;Technical Overview&lt;&#x2F;h2&gt;
&lt;p&gt;Enviame is a Server Side Rendered (SSR) Multi-Page Application (MPA) with AJAX.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;main-features&quot;&gt;Main Features&lt;&#x2F;h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;User Authentication&lt;&#x2F;strong&gt;: Easy login and registration, secure and persistent storage with PostgreSQL&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Email Delivery&lt;&#x2F;strong&gt;: Immediate notification delivery with SMTP, with multiple priority options&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Calendar Status&lt;&#x2F;strong&gt;: Integration with the &lt;a rel=&quot;nofollow noreferrer&quot; href=&quot;https:&#x2F;&#x2F;icalendar.org&#x2F;&quot;&gt;iCalendar&lt;&#x2F;a&gt; protocol, displays current status and expected contact hours&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h3 id=&quot;tech-stack&quot;&gt;Tech Stack&lt;&#x2F;h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Backend&lt;&#x2F;strong&gt;: Rust
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;axum&lt;&#x2F;code&gt;: Web Framework&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;tokio&lt;&#x2F;code&gt;: Asynchronous Runtime&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;lettre&lt;&#x2F;code&gt;: SMTP Email Delivery&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;sqlx&lt;&#x2F;code&gt;: Database Interaction&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;askama&lt;&#x2F;code&gt;: Static HTML Templating&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Database&lt;&#x2F;strong&gt;: PostgreSQL&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Frontend&lt;&#x2F;strong&gt;:
&lt;ul&gt;
&lt;li&gt;Static HTML&lt;&#x2F;li&gt;
&lt;li&gt;Vanilla JS&lt;&#x2F;li&gt;
&lt;li&gt;Bootstrap UI&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;hr &#x2F;&gt;
&lt;h2 id=&quot;design-decisions&quot;&gt;Design Decisions&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;1-using-rust-as-backend&quot;&gt;1. Using Rust as Backend&lt;&#x2F;h3&gt;
&lt;p&gt;Rust has some obvious advantages over the more popular backend options such as Node.js or Python. It is a static, compiled language with complete type safety, the ownership model is great at preventing data races in a multi-thread context, and the Cargo ecosystem is rich enough for tasks like sending emails or converting datetimes to feel like a cakewalk. Not only is runtime significantly faster but the developer is also significantly less likely to make mistakes.&lt;&#x2F;p&gt;
&lt;p&gt;The project was intended for me to gauge the difficulty of writing an actual multi-threaded server in Rust. So far, I am delighted by what Rust has to offer.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;2-using-ssr-instead-of-an-spa-as-frontend&quot;&gt;2. Using SSR instead of an SPA as Frontend&lt;&#x2F;h3&gt;
&lt;p&gt;This was a debatable decision. A simple excuse would be that the app only has a few pages and building an entire separate frontend would be unnecessarily complex, but that would contradict the &lt;a href=&quot;https:&#x2F;&#x2F;blog.brianc.me&#x2F;projects&#x2F;enviame&#x2F;#design-philosophy&quot;&gt;design philosophy&lt;&#x2F;a&gt; of using the &quot;industry standard solution&quot;, SPAs are, at least as of right now, definitely the &lt;em&gt;de facto&lt;&#x2F;em&gt; standard for a frontend.&lt;&#x2F;p&gt;
&lt;p&gt;To put brutally, I am a systems&#x2F;backend developer, and the initial motivation for the project was to experiment with a Rust backend. I did not plan to nor have the time to spend on the frontend, while also adding complexity to the backend structure since I now have &lt;a rel=&quot;nofollow noreferrer&quot; href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Cross-origin_resource_sharing&quot;&gt;CORS&lt;&#x2F;a&gt; to worry about.&lt;&#x2F;p&gt;
&lt;p&gt;AJAX was indeed slightly less enjoyable and perhaps more verbose than using Svelte or React, but for a &quot;two-form&quot; app like this, it was definitely a good trade-off. I would say, if some day I start to make an application with more than a dozen pages, or if those pages are more complex than one or two forms and half a dozen buttons, then an SPA would probably be the way to go.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;3-choosing-postgresql-as-the-database-solution&quot;&gt;3. Choosing PostgreSQL as the Database Solution&lt;&#x2F;h3&gt;
&lt;p&gt;Honestly, not a lot of thought went into this decision. PostgreSQL is pretty much also the &lt;em&gt;de facto&lt;&#x2F;em&gt; database for modern large-scale applications. Given the design philosophy of scalability, this was a no-brainer.&lt;&#x2F;p&gt;
&lt;p&gt;Given that the project did not use any of PostgreSQL&#x27;s advanced features, an alternative would be SQLite, which is more portable and likely faster and easier to set up.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;4-using-in-memory-scheduling-for-email-and-calendar-workers-instead-of-cron-jobs&quot;&gt;4. Using In-Memory Scheduling for Email and Calendar Workers instead of Cron Jobs&lt;&#x2F;h3&gt;
&lt;p&gt;Cron jobs will be more lightweight, have less CPU usage and is generally a more popular option for production systems. I opted for in-memory scheduling since I don&#x27;t think the difference in the context of this project is significant enough to justify the more complex setup (&lt;em&gt;e.g.,&lt;&#x2F;em&gt; including an entire API endpoint so that the cron job can update the calendar status).&lt;&#x2F;p&gt;
&lt;p&gt;The disadvantage is, if the app panics and aborts, the remaining emails won&#x27;t get sent and the calendar won&#x27;t be updated. However, given the decision to use SSR, the app wouldn&#x27;t even display a home page if the process is not running.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;5-using-sqlx-for-database-integration&quot;&gt;5. Using &lt;code&gt;sqlx&lt;&#x2F;code&gt; for Database Integration&lt;&#x2F;h3&gt;
&lt;p&gt;This was a simple decision. Even though &lt;code&gt;sqlx&lt;&#x2F;code&gt; pulls in more dependencies than something like &lt;code&gt;postgres&lt;&#x2F;code&gt;, the static typechecking for the database along with the support for timestamptz (timestamp with timezones) makes the development experience a lot easier and a lot more enjoyable.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;6-using-askama-as-the-templating-engine&quot;&gt;6. Using &lt;code&gt;askama&lt;&#x2F;code&gt; as the Templating Engine&lt;&#x2F;h3&gt;
&lt;p&gt;Also a simple decision. &lt;code&gt;askama&lt;&#x2F;code&gt; performs template syntax checks during compile time (as opposed to runtime for &lt;code&gt;tera&lt;&#x2F;code&gt;), meaning the app is both safer and faster at runtime.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;askama&lt;&#x2F;code&gt; also has simple and straightforward syntax (which, surprisingly, &lt;code&gt;html-minifier&lt;&#x2F;code&gt; also had no issues handling), along with strong typing.&lt;&#x2F;p&gt;
&lt;p&gt;Comparing &lt;code&gt;askama&lt;&#x2F;code&gt; and &lt;code&gt;maud&lt;&#x2F;code&gt;, in retrospect the latter might be a better option for performance, but porting from multiple HTML files (with duplicate sections) was likely easier for &lt;code&gt;askama&lt;&#x2F;code&gt; - I cannot tell for sure.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;7-other-deployment-decisions&quot;&gt;7. Other Deployment Decisions&lt;&#x2F;h3&gt;
&lt;p&gt;Since a lot of decisions were made during the deployment process, here&#x27;s a summary with justification:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Self-hosting Database&lt;&#x2F;strong&gt; instead of Supabase or Firebase: Easier to debug, cleaner structure&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Custom Build Configuration&lt;&#x2F;strong&gt;: Prioritise runtime speed over compile speed&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Minimal Dependencies&lt;&#x2F;strong&gt;: Still optimise for compile speed and binary size&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;hr &#x2F;&gt;
&lt;h2 id=&quot;challenges-and-solutions&quot;&gt;Challenges and Solutions&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;smtp-email-delivery&quot;&gt;SMTP Email Delivery&lt;&#x2F;h3&gt;
&lt;p&gt;After experimenting with SendGrid, I decided that it was way too unreliable, almost always going to spam, which defeats the purpose of notification emails or message receipts.&lt;&#x2F;p&gt;
&lt;p&gt;Since I am managing my domain emails via iCloud, I decided to experiment with iCloud&#x27;s SMTP. It rarely went to spam and testing succeeded so I kept it as my option.&lt;&#x2F;p&gt;
&lt;p&gt;In the following days, there are multiple occurrences of emails being delivered on the next morning or straight up not being delivered at all, without any error logs on the server. When manually inspected, it seems that iCloud would also return a &lt;code&gt;202 Accepted&lt;&#x2F;code&gt; for these emails but for some reason they are either rejected or queued for unreasonably long hours.&lt;&#x2F;p&gt;
&lt;p&gt;After some painful debugging, I found out that these &quot;delayed&quot; emails have a iCloud spam header set to true. It turns out, as my email template was a few lines of plain text and my test messages were often random letters, iCloud would mark some of them, especially repeated attempts of the exact same message, as spam. Presumably these then went through human review, hence some messages went through hours later while others got rejected.&lt;&#x2F;p&gt;
&lt;p&gt;This was fixed very easily by using a proper HTML template for my email, and setting the content to HTML instead of plain text.&lt;&#x2F;p&gt;
&lt;p&gt;It was somewhat irritating to debug this. Since the delivery behaviour was inconsistent (and not 100% failure), there were multiple times where I wrongly deduced the cause of the bug due to two attempts one succeeding and one failing - when in reality it&#x27;s just because iCloud decided to mark the latter as spam.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;sqlx-and-ci-cd&quot;&gt;&lt;code&gt;sqlx&lt;&#x2F;code&gt; and CI&#x2F;CD&lt;&#x2F;h3&gt;
&lt;p&gt;This is what happens when you ask ChatGPT to generate the code for you instead of reading the docs. I asked ChatGPT for the standard template to connect to and send queries to a PostgreSQL database, it told me I could use the &lt;code&gt;sqlx::query!&lt;&#x2F;code&gt; macro, I tested it out and realised it supported compile-time type-checking, then I just left it in the code.&lt;&#x2F;p&gt;
&lt;p&gt;When the time to deploy comes, I decided that a standard build and deploy CI&#x2F;CD pipeline wouldn&#x27;t work, since the GitHub Actions runner doesn&#x27;t have a postgres database with the proper schema. Therefore, I opted for the more complicated solution, which is to write an &lt;em&gt;ad hoc&lt;&#x2F;em&gt; bash script on the server to handle updates.&lt;&#x2F;p&gt;
&lt;p&gt;After deciding in v1.0.8 to make the deployment process smoother, I wrote a ridiculous workflow that created a postgres database, applied the schema, then used that to compile the binary. I again asked ChatGPT to generate the workflow for me, and luckily, this time it decided to give me &lt;code&gt;sqlx prepare&lt;&#x2F;code&gt; for some unknown reason (it&#x27;s incorrect syntax-wise, and it&#x27;s also not the appropriate command in this context...). Curiosity got the better of me and after researching I figured out that there has always been an &quot;offline&quot; mode for the type-checking performed by &lt;code&gt;sqlx&lt;&#x2F;code&gt;. You can use &lt;code&gt;cargo sqlx prepare&lt;&#x2F;code&gt; to generate the cache, making a normal deployment workflow possible as long as this cache is checked into version control.&lt;&#x2F;p&gt;
&lt;p&gt;Stupid mistake, gladly it got fixed, now I know better.&lt;&#x2F;p&gt;
&lt;hr &#x2F;&gt;
&lt;h2 id=&quot;further-improvements&quot;&gt;Further Improvements&lt;&#x2F;h2&gt;
&lt;p&gt;This section describes possible further improvements that likely won&#x27;t be implemented. For features in development and planned for v1.1.0, see &lt;a rel=&quot;nofollow noreferrer&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;differental&#x2F;enviame&#x2F;releases&#x2F;tag&#x2F;v1.0.7&quot;&gt;v1.0.7 release notes&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Add unit tests and integration tests&lt;&#x2F;li&gt;
&lt;li&gt;Add proper logging in different levels&lt;&#x2F;li&gt;
&lt;li&gt;Implement OAuth2 for third-party login options&lt;&#x2F;li&gt;
&lt;li&gt;Separate the frontend and refactor to an SPA framework like React or Svelte&lt;&#x2F;li&gt;
&lt;li&gt;Improve database scalability by implementing sharding or read replicas&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;hr &#x2F;&gt;
&lt;h2 id=&quot;afterthoughts&quot;&gt;Afterthoughts&lt;&#x2F;h2&gt;
&lt;p&gt;Enviame started as a single-page tool with one endpoint to deliver messages. Then token-based login was added to simplify UX, then registration was added, then email delivery with different priorities was added... Before long it became a playground for me to experiment with various industry-standard solutions, and it was definitely an enjoyable ride. Most of the fun came from the entire process of envisioning, designing, and building from scratch, then stumbling across a blog post explaining the exact same thing.&lt;&#x2F;p&gt;
&lt;p&gt;Rust definitely made the development process a lot smoother and more enjoyable compared with similar Python servers I&#x27;ve written in the past. Having carefully studied &lt;a rel=&quot;nofollow noreferrer&quot; href=&quot;https:&#x2F;&#x2F;rust-book.cs.brown.edu&#x2F;&quot;&gt;TRPL&lt;&#x2F;a&gt; last year, I hardly encountered any Rust-specific issues. Even when the borrow checker occasionally complained, it&#x27;s usually an immediate realisation and an easy fix. The type system and the ownership model definitely saved me hours or days of painful debugging.&lt;&#x2F;p&gt;
&lt;p&gt;The experience with CI&#x2F;CD was slightly painful but fun, while the experience with SMTP was mostly just painful. Still, it&#x27;s the kind of chaos I signed up for, and it&#x27;s definitely satisfying to discover the root cause of the issue through layer-by-layer debugging, as underwhelming as &quot;test emails were blocked by iCloud&#x27;s spam filter&quot; sounds like.&lt;&#x2F;p&gt;
&lt;p&gt;All in all, a very rewarding side quest.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>IDP - Software Documentation</title>
          <pubDate>Mon, 17 Mar 2025 00:00:00 +0000</pubDate>
          <author>Brian Chen</author>
          <link>https://blog.brianc.me/projects/idp/</link>
          <guid>https://blog.brianc.me/projects/idp/</guid>
          <description xml:base="https://blog.brianc.me/projects/idp/">

&lt;div
  class=&quot;my-4 flex flex-col rounded-lg bg-[var(--admonition-bg)]&quot;
  style=&quot;--admonition-bg: rgba(0, 191, 165, 0.1);&quot;
&gt;
  &lt;div class=&quot;flex items-center rounded-t-lg bg-[var(--admonition-bg)] p-1&quot;&gt;
    &lt;div
      class=&quot;mx-2 h-4 w-4 text-[0] [background:var(--url)_center_center_no-repeat] dark:invert&quot;
      style=&quot;--url: url(.&#x2F;icons&#x2F;tip.svg);&quot;
    &gt;
      tip
    &lt;&#x2F;div&gt;
    &lt;span&gt;&lt;strong&gt;Copyright Notice&lt;&#x2F;strong&gt;&lt;&#x2F;span&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;pl-4&quot;&gt;&lt;p&gt;This post is licensed under &lt;a rel=&quot;nofollow noreferrer&quot; href=&quot;https:&#x2F;&#x2F;creativecommons.org&#x2F;licenses&#x2F;by-nc-nd&#x2F;4.0&#x2F;&quot;&gt;CC BY-NC-ND 4.0&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;


&lt;div
  class=&quot;my-4 flex flex-col rounded-lg bg-[var(--admonition-bg)]&quot;
  style=&quot;--admonition-bg: rgba(83, 211, 230, 0.1);&quot;
&gt;
  &lt;div class=&quot;flex items-center rounded-t-lg bg-[var(--admonition-bg)] p-1&quot;&gt;
    &lt;div
      class=&quot;mx-2 h-4 w-4 text-[0] [background:var(--url)_center_center_no-repeat] dark:invert&quot;
      style=&quot;--url: url(.&#x2F;icons&#x2F;info.svg);&quot;
    &gt;
      info
    &lt;&#x2F;div&gt;
    &lt;span&gt;&lt;strong&gt;Note&lt;&#x2F;strong&gt;&lt;&#x2F;span&gt;
  &lt;&#x2F;div&gt;
  &lt;div class=&quot;pl-4&quot;&gt;&lt;p&gt;The UML diagrams provided below may not strictly adhere to formal UML standards, as formal UML notation is introduced in fourth year and thus is not a requirement for this project&#x27;s documentation.&lt;&#x2F;p&gt;
&lt;p&gt;They should, however, clearly and concisely reflect the structure of the project.&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;&#x2F;div&gt;
&lt;h2 id=&quot;diagrams&quot;&gt;Diagrams&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;class-diagram&quot;&gt;Class Diagram&lt;&#x2F;h3&gt;
&lt;pre class=&quot;mermaid bg-inherit&quot; translate=&quot;no&quot;&gt;
  
classDiagram
    class PathFinder {
        +dijkstras(start: Node, end: Node) List~Instruction~
    }

    class PicoBot {
        +move(instructions: List~Instruction~)
        +turn(is_180: bool)
        +walk()
        +pick_up(node: int)
        +drop_off(depot: int)
    }

    class MissionControl {
        +start()
        +on_bootup()
        +on_finish()
    }

    class ColorSensor {
        +get_colour() str
    }

    class LineSensor {
        +value() bool
    }

    class Motor {
        +Forward(percentage: int)
        +Reverse(percentage: int)
        +off()
    }

    class Servo {
        +rotate(angle: int)
    }

    MissionControl --&amp;gt; PathFinder : calls
    MissionControl --&amp;gt; PicoBot : commands
    PicoBot --&amp;gt; ColorSensor : reads from
    PicoBot --&amp;gt; LineSensor : reads from
    PicoBot --&amp;gt; Motor : operates
    PicoBot --&amp;gt; Servo : operates

&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;sequence-diagram&quot;&gt;Sequence Diagram&lt;&#x2F;h3&gt;
&lt;pre class=&quot;mermaid bg-inherit&quot; translate=&quot;no&quot;&gt;
  
sequenceDiagram
    actor User
    participant MC as MissionControl
    participant PF as PathFinder
    participant PB as PicoBot
    participant LS as LineSensor
    participant CS as ColorSensor
    participant M as Motor
    participant SM as Servo

    User -&amp;gt;&amp;gt; MC: Press button to start mission
    MC -&amp;gt;&amp;gt; PF: dijkstras(start, target)
    PF --&amp;gt;&amp;gt; MC: Returns list of instructions

    MC -&amp;gt;&amp;gt; PB: move(instructions)

    loop Execute each instruction
        PB -&amp;gt;&amp;gt; M: Execute TurnInstruction or WalkInstruction
        PB -&amp;gt;&amp;gt; LS: Check line sensors for line following
        LS --&amp;gt;&amp;gt; PB: Direction correction
    end

    MC -&amp;gt;&amp;gt; PB: pick_up()
    PB -&amp;gt;&amp;gt; SM: Rotate servo to pick up box
    PB -&amp;gt;&amp;gt; CS: Check color sensor
    CS --&amp;gt;&amp;gt; MC: Return detected color

    MC -&amp;gt;&amp;gt; PF: dijkstras(target, depot)
    PF --&amp;gt;&amp;gt; MC: Returns list of instructions

    MC -&amp;gt;&amp;gt; PB: move(instructions)

    loop Execute each instruction
        PB -&amp;gt;&amp;gt; M: Execute TurnInstruction or WalkInstruction
        PB -&amp;gt;&amp;gt; LS: Check line sensors for line following
        LS --&amp;gt;&amp;gt; PB: Direction correction
    end

    MC -&amp;gt;&amp;gt; PB: drop_off()
    PB -&amp;gt;&amp;gt; SM: Rotate servo to drop off box

    MC -&amp;gt;&amp;gt; MC: Loop back to step 2 with a new target node

&lt;&#x2F;pre&gt;
</description>
      </item>
    </channel>
</rss>
